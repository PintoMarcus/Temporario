# Parâmetros de entrada para a conexão
$ServerName = Read-Host "Digite o nome do servidor SQL"
$Login = Read-Host "DBA - Entre com seu Login"
$SecurePassword = Read-Host "DBA - Digite sua senha" -AsSecureString

# Converte a senha de SecureString para String
$BSTR = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($SecurePassword)
$Password = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR)

# Estabelece a conexão com o SQL Server usando a autenticação "SQL Server Authentication"
$Connection = New-Object System.Data.SqlClient.SqlConnection
$Connection.ConnectionString = "Server=$ServerName;User ID=$Login;Password=$Password;Database=master;Integrated Security=False;"
$Connection.Open()

# Parâmetros de entrada para criar o novo login
$NewLogin = Read-Host "Insira o login do NOVO USUÁRIO"

# Solicitar a senha e confirmar a senha
$NewPassword = Read-Host "Digite a senha" -AsSecureString
$ConfirmPassword = Read-Host "Confirme a senha" -AsSecureString

# Converte as senhas de SecureString para String
$BSTR1 = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($NewPassword)
$NewPasswordString = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR1)

$BSTR2 = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($ConfirmPassword)
$ConfirmPasswordString = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR2)

# Verificar se as senhas coincidem
if ($NewPasswordString -eq $ConfirmPasswordString) {
    # Comando SQL para criar o login
    $SqlCommand = @"
    USE MASTER
    CREATE LOGIN "$NewLogin" WITH PASSWORD = '$NewPasswordString', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF    
"@

    # Executa o comando no servidor
    $Command = $Connection.CreateCommand()
    $Command.CommandText = $SqlCommand
    $Command.ExecuteNonQuery()
    Write-Host "Login '$NewLogin' criado com sucesso."
} else {
    Write-Host "As senhas não coincidem. Operação cancelada. Nenhum login foi criado."
}

# Fecha a conexão
$Connection.Close()
